title: 简单服务器架构改造
date: 2015-11-11 08:51:42
tags: [Server, Framework]
---

最近朋友需要做一个线上流量峰值很大的活动，第一天由于某段时间太多人并发访问，服务器性能到峰值就崩溃了。他用的是Discuz里面一个简单插件，之前是付钱让外面的人帮忙搭起来的。我那天晚上看了一下情况，然后我也达到疯值崩溃了。

他们在阿里云买了单台服务器，所有东西丢进去，把CPU，内存和网络资源调整得比较高。一台云服务器甚至比我做的一套框架还贵😂。为了避免高并发带来的系统崩溃，我开始帮他在现有的系统下改服务器架构。

<!-- more -->

## 单服务器

他们原来的部署逻辑是把所有的东西丢在同一台服务，然后把这台服务器的性能调高。显然这种小学生的做法只可以满足一些低并发的需求，几个人玩玩泥沙这样做是没问题的。但是，我朋友的活动有几十万人参与，而且有比较集中的峰值，这种架构显然不能撑起所有访问。

![singleserver](http://7xo6cz.com1.z0.glb.clouddn.com/20151111/singleserver.png)

## 负载均衡

首先我把数据库进行了分离，业务处理与数据处理的分离有效减少服务器的计算和IO压力。云数据库本身的HA和定期备份比较有保证。这样数据本身可以安全的被隔离，而读写访问的压力也分离了。

之后我用四台性能比前面提及到的单机低的云服务器，分别搭建了该系统。由于系统程序本身的局限性，我把业务逻辑和文件处理放在了一起，加上一个负载均衡做访问分发。由于Session同步问题，我使用了源IP访问的形式进行访问的分发。

![laodbalance](http://7xo6cz.com1.z0.glb.clouddn.com/20151111/loadbalance.png)

## 文件服务器

经过数据库分离和负载均衡，在峰值的时候我们发现速度有所改进，页面打开的时候很快有反应，但是图片加载非常慢，导致整体页面打开速度非常慢。通过服务器的参数对比，发现网络流量占用特别大，原因是图片没有集中存储进行独立分发，需要在四台服务器进行分发。当大量并发访问的时候，所有的流量都用于分发图片，没办法支撑起新的请求。

我们立刻做了一个应急处理，我把所有服务器的带宽都动态调整到较大的最高值。而且，我发现大量图片占用的空间偏大，分发的时候严重占用带宽，就算缩小10倍也不会影响用户使用。所以，我让朋友把所有图片都缩小。最后利用这种方法听过去，活动顺利结束。

由于这类活动会频繁举行，我想在空档期间把系统进行改造。把图片服务器分离出来，使用第三方对象存储进行图片访问和分发，例如现在很火的[七牛][qiniu]。由于这种改造需求修改源码，所以日后开始开发的时候就需要考虑到这种情况。

![withfileserver](http://7xo6cz.com1.z0.glb.clouddn.com/20151111/withfileserver.png)

[qiniu]: http://www.qiniu.com/

## 内存存储

到再下一步，网站比较多动态态数据更新频率不高，可以用内存存储进行纪录。而且对与网站访问，把Session统一存放也是比较好管理的。所以，增加内存存储能够帮助系统提升性能和可用性。有了内存存储能够提升部分访问速度，而且可以把负载均衡的分发改成轮询，使应用服务器的压力分配比较平均。

![withmemory](http://7xo6cz.com1.z0.glb.clouddn.com/20151111/withmemory.png)

## 总结

当我们做服务器架构的时候需要考虑大一点，不是把所有东西放在一台服务器上，然后把单台服务器性能提升就可以解决问题的。术业有专攻，不同的服务器完成不同的功能，通力合作，这样顺利才能完成大量任务。当然，要处理更大的业务量，这种架构肯定好快出现瓶颈，还有很多更加细节的优化需要注意。

这里只是纪录我平时的一些工作或者一些想法，也会写一写自己对一些技术的理解，当然还会分享一些比较厉害的文章。